# å¾…åŠäº‹é¡¹ä¸æ—¥ç¨‹è¡¨è®¾è®¡è¯´æ˜ (Unified Activities Schema)

## 1. ä¸šåŠ¡ç›®æ ‡ä¸æ”¹è¿›æ€è€ƒ

æ‚¨æåˆ°çš„é—®é¢˜éå¸¸å…³é”®ï¼š**åœ¨è‡ªç„¶è¯­è¨€è¾“å…¥ï¼ˆç‰¹åˆ«æ˜¯è¯­éŸ³ï¼‰ä¸­ï¼Œâ€œå¾…åŠäº‹é¡¹ (Task)â€ä¸â€œæ—¥ç¨‹å®‰æ’ (Event)â€çš„ç•Œé™é€šå¸¸æ˜¯æ¨¡ç³Šçš„ã€‚**
ä¾‹å¦‚ï¼š
- â€œæ˜å¤©ä¸‹åˆ 3 ç‚¹å»å¼€ä¼šâ€ ï¼ˆé€šå¸¸è¢«è¯†åˆ«ä¸ºä¸€ä¸ªå…·å¤‡èµ·æ­¢æ—¶é—´çš„æ—¥ç¨‹ Eventï¼‰
- â€œæ˜å¤©ä¸‹åˆ 3 ç‚¹å‰æŠŠæŠ¥å‘Šå‘å‡ºå»â€ ï¼ˆé€šå¸¸è¢«è¯†åˆ«ä¸ºä¸€ä¸ªå…·å¤‡æˆªæ­¢æ—¶é—´çš„å¾…åŠ Taskï¼‰
- â€œæé†’æˆ‘æ˜å¤©ä¸‹åˆ 3 ç‚¹åƒè¯â€ ï¼ˆé€šå¸¸è¢«è¯†åˆ«ä¸ºä¸€ä¸ªæé†’ Reminderï¼‰

å¦‚æœæˆ‘ä»¬åœ¨åº•å±‚ç¡¬æ€§åˆ’åˆ†ä¸ºä¸¤ä¸ªç‹¬ç«‹çš„è¡¨ï¼ˆ`tasks` å’Œ `calendar_events`ï¼‰ï¼ŒAI åœ¨æ„å›¾åˆ¤æ–­ï¼ˆIntent Parsingï¼‰æ—¶å°±ä¼šå¾ˆå®¹æ˜“å‡ºé”™ï¼Œä¸”å½“ç”¨æˆ·æƒ³æŠŠä¸€ä¸ªâ€œå¾…åŠâ€è½¬æ¢æˆä¸€æ®µå…·ä½“çš„â€œæ—¥ç¨‹â€æ—¶ï¼Œæ•°æ®è¿ç§»é€»è¾‘ä¼šéå¸¸ç¹çã€‚

**æ”¹è¿›æ–¹æ¡ˆï¼šé‡‡ç”¨å¤§ä¸€ç»Ÿçš„ `activities`ï¼ˆæ´»åŠ¨ï¼‰è¡¨**
æˆ‘ä»¬å°†æ‰€æœ‰å¸¦æœ‰æ—¶é—´å±æ€§çš„è¡ŒåŠ¨æŠ½è±¡ä¸º `activities`ã€‚é€šè¿‡å­—æ®µçš„ä¸åŒç»„åˆï¼Œåœ¨åº”ç”¨å±‚è‡ªç„¶æ˜ å°„å‡ºå¾…åŠæˆ–æ—¥ç¨‹çš„è§†å›¾ã€‚

## 2. è¡¨ç»“æ„è®¾è®¡ (`activities`)

æ­¤è¡¨ç”¨äºå­˜å‚¨æ‰€æœ‰çš„ä»»åŠ¡ã€æ—¥ç¨‹å’Œæé†’ã€‚

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | æè¿° |
| :--- | :--- | :--- | :--- |
| `id` | `UUID` | `PRIMARY KEY`, é»˜è®¤ç”Ÿæˆ | è®°å½•å”¯ä¸€æ ‡è¯† |
| `user_id` | `UUID` | `NOT NULL` | å…³è”åˆ°æ‰€å±ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†ï¼ˆå…³è”è®¤è¯ç³»ç»Ÿï¼‰ |
| `title` | `TEXT` | `NOT NULL` | ç®€è¦æ ‡é¢˜ / æ ¸å¿ƒæ„å›¾ |
| `description` | `TEXT` | `NULL` | è¯¦ç»†æè¿° |
| `type` | `TEXT` | `CHECK In ('task', 'event', 'reminder')`, é»˜è®¤ `'task'` | æ´»åŠ¨ç±»å‹ã€‚å¸®åŠ©å‰ç«¯å†³å®šå¦‚ä½•æ¸²æŸ“å¡ç‰‡æˆ–è¡¨å• |
| `status` | `TEXT` | `CHECK In ('needs_action', 'in_process', 'completed', 'cancelled')`, é»˜è®¤ `'needs_action'` | æ´»åŠ¨çŠ¶æ€ï¼ˆå¾…åŠçš„æ‰“å‹¾çŠ¶æ€ï¼Œèµ›ç¨‹çš„å‚ä¸çŠ¶æ€ç­‰ï¼‰|
| `priority` | `TEXT` | `CHECK In ('low', 'medium', 'high', 'urgent')`, é»˜è®¤ `'medium'` | ä¼˜å…ˆçº§ |
| `start_time` | `TIMESTAMPTZ` | `NULL` | å¼€å§‹æ—¶é—´ (äº‹ä»¶å¿…å¡«ï¼Œå¾…åŠå¯ä¸ºç©º) |
| `end_time` | `TIMESTAMPTZ` | `NULL` | ç»“æŸæ—¶é—´ / æˆªæ­¢æ—¥æœŸæˆªæ­¢æ—¥æœŸã€‚(äº‹ä»¶å¿…å¡«ï¼Œä¸”å¿…é¡» `>= start_time`ï¼›å¾…åŠä½œä¸º Due Date ä½¿ç”¨) |
| `is_all_day` | `BOOLEAN` | é»˜è®¤ `FALSE` | æ˜¯å¦æ˜¯å…¨å¤©äº‹ä»¶ |
| `location` | `TEXT` | `NULL` | åœ°ç‚¹æˆ–ç›¸å…³é“¾æ¥ |
| `tags` | `TEXT[]` | é»˜è®¤ `'{}'` | è‡ªå®šä¹‰æ ‡ç­¾ |
| `created_at` | `TIMESTAMPTZ` | `NOT NULL`, é»˜è®¤å½“å‰ UTC æ—¶é—´ | è®°å½•åˆ›å»ºæ—¶é—´ |
| `updated_at` | `TIMESTAMPTZ` | `NOT NULL`, é»˜è®¤å½“å‰ UTC æ—¶é—´ | è®°å½•æ›´æ–°æ—¶é—´ï¼ˆè§¦å‘å™¨è‡ªåŠ¨æ›´æ–°ï¼‰ |

### 2.1 è¡¨ç°å½¢å¼æ˜ å°„é€»è¾‘ (ç»™ AI å’Œå‰ç«¯çš„è§„åˆ™)

1. **çº¯å¾…åŠä»»åŠ¡ (Task without deadline)**
   - `type` = 'task', `start_time` = null, `end_time` = null
2. **å¸¦æˆªæ­¢æ—¥æœŸçš„ä»»åŠ¡ (Task with due date)**
   - `type` = 'task', `start_time` = null, `end_time` = [æˆªæ­¢æ—¶é—´]
3. **æ—¥ç¨‹äº‹ä»¶ (Event)**
   - `type` = 'event', `start_time` = [å¼€å§‹æ—¶é—´], `end_time` = [ç»“æŸæ—¶é—´]
4. **å•ç‚¹æé†’ (Reminder)**
   - `type` = 'reminder', `start_time` = [æé†’æ—¶é—´], `end_time` = null

## 3. æ€§èƒ½ä¼˜åŒ–è®¾è®¡

ä¸ºæ»¡è¶³æœªæ¥çš„é«˜é¢‘æŸ¥è¯¢ï¼ˆæ¯”å¦‚â€œæ‹‰å–ä¸‹å‘¨æ‰€æœ‰çš„æ´»åŠ¨â€ï¼‰ï¼Œæˆ‘ä»¬å»ºç«‹äº†ä»¥ä¸‹ç´¢å¼•ï¼š
- `activities_time_idx`: åœ¨ `(start_time, end_time)` ä¸Šå»ºç«‹è”åˆç´¢å¼•ï¼Œç”¨äºåœ¨æ—¥å†è§†å›¾ä¸­å¿«é€Ÿæ¡†é€‰ä¸€ä¸ªæ—¶é—´æ®µã€‚
- `activities_user_idx`: é’ˆå¯¹ `user_id` çš„ç´¢å¼•ã€‚
- `activities_status_idx`: åœ¨ `(status, type)` ä¸Šå»ºç«‹è”åˆç´¢å¼•ï¼Œç”¨äºåœ¨ä»»åŠ¡æ¸…å•è§†å›¾ä¸­å¿«é€Ÿæ‹‰å–æœªå®Œæˆçš„ä»»åŠ¡ï¼ˆä¾‹å¦‚ `status = 'needs_action'`ï¼‰ã€‚

## 4. æƒé™ä¸å®‰å…¨ç­–ç•¥ (Row Level Security - RLS)

å¯ç”¨ RLS ç­–ç•¥ï¼Œç¡®ä¿å¤šè®¾å¤‡å’Œå¤šç«¯è®¿é—®ä¸‹çš„ç»å¯¹å®‰å…¨ï¼š
- å¢ (INSERT) / åˆ  (DELETE) / æ”¹ (UPDATE) / æŸ¥ (SELECT) å‡ä¼šå¯¹æ¯”è®°å½•çš„ `user_id` ä¸ JWT Token ä¸­çš„ `auth.uid()`ã€‚

## 5. è‡ªåŠ¨ç»´æŠ¤æœºåˆ¶ (Triggers)

é…ç½®äº† `update_updated_at_column` è§¦å‘å™¨ï¼Œåœ¨æ¯æ¬¡æ›´æ–°è®°å½•æ—¶è‡ªåŠ¨åŒæ­¥ `updated_at` ä¸ºå½“å‰æ—¶é—´ã€‚

---
ğŸ’¡ **åç»­ä¼˜åŠ¿**ï¼šè¿™ç§æ‰å¹³åŒ–çš„ç»“æ„è®¾è®¡æå¤§é™ä½äº† AI å‡½æ•°è°ƒç”¨çš„å¤æ‚åº¦ã€‚æˆ‘ä»¬åªéœ€è¦ç»™å¤§æ¨¡å‹æš´éœ²ä¸€ä¸ª `upsert_activity` çš„å·¥å…·ï¼Œå®ƒå†ä¹Ÿä¸ç”¨çº ç»“â€œæˆ‘æ˜¯è¯¥è°ƒç”¨æ–°å¢ä»»åŠ¡è¿˜æ˜¯æ–°å¢æ—¥ç¨‹â€ï¼Œç›´æ¥å…¨é‡æ„é€ å­—æ®µå¡«å……å³å¯ã€‚

è¯·ç¡®è®¤è¿™ä¸ªå¤§ä¸€ç»Ÿçš„è®¾è®¡ç¬¦åˆæ‚¨çš„æƒ³æ³•ã€‚å¦‚æœç¡®è®¤æ— è¯¯ï¼Œæ‚¨å¯ä»¥ç›´æ¥æ‰§è¡Œæ›´æ–°åçš„ [supabase/calendar_tasks_schema.sql](file:///f:/FrankAI/gemini-chat-pwa/supabase/calendar_tasks_schema.sql) è„šæœ¬ã€‚
